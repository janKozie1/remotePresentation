<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background:black;
        }

        #video_output {
            display: none;
            width: 100%;
        }
        #image_output{
            width:100%;
        }
    </style>
</head>

<body>
    <img id="image_output" src="/defaultImage">
    <video id="video_output">

    </video>
    <script>

        // (function openFullscreen() {
        //     let elem = document.documentElement;
        //     if (elem.requestFullscreen) {
        //         elem.requestFullscreen();
        //     } else if (elem.mozRequestFullScreen) { 
        //         elem.mozRequestFullScreen();
        //     } else if (elem.webkitRequestFullscreen) {
        //         elem.webkitRequestFullscreen();
        //     } else if (elem.msRequestFullscreen) {
        //         elem.msRequestFullscreen();
        //     }
        // })()

        let media = []
        let counter = 0
        let key = null
        let defaultDuration = 3000
        let duration = 1000
        let video_playing = false
        const MEDIA_TYPES = {
            image: ['.jpg', '.png', '.gif'],
            video: ['.mp4', '.webm']
        }
        let image_output = document.getElementById('image_output')
        let video_output = document.getElementById('video_output')
        video_output.addEventListener('ended', handleVideoEnd)
        getImage(media)
        pres();

        function handleVideoEnd() {
            counter++
            if (counter >= media.length) {
                counter = 0
            }
            video_output.pause()
            video_output.innerHTML = ""
            video_playing = false
            pres()
        }

        function getImage(imgArray) {
            fetch('http://127.0.0.1:8080/getImages', {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key
                })
            })
                .then((e) => e.json())
                .then((res) => {
                    console.log(res)
                    if (res.key !== key) {
                        media = [...res.media]
                        key = res.key
                        defaultDuration = res.defaultDuration <= 0 ? 3000 : res.defaultDuration * 1000
                        if(!media.length){
                            image_output.style.display='none';
                            video_output.style.display="none";
                        }else{
                            image_output.style.display='block';
                           
                        }
                    }
                }).catch((err) => {

                });
        }


        function pres(){
            if (media.length) {


                let currentMedia = media[counter]
                
                if (currentMedia) {
                    try {
                        duration = currentMedia.params.duration*1000;
                        let fileExtension = currentMedia.fileName.substr(currentMedia.fileName.lastIndexOf('.')).toLowerCase();
                        let mediaType = determineType(fileExtension);
                        if (mediaType === 'image') {
                            video_output.style.display = "none"
                            image_output.style.display = 'block'
                            image_output.src = `data:image/${fileExtension.replace(/\./g, '')};base64,` + currentMedia.base64
                            counter++
                            if (counter >= media.length) {
                                counter = 0
                            }
                        } else {
                            image_output.style.display = 'none'
                            video_output.style.display = "block"
                            let src = document.createElement('source')
                            src.setAttribute('src', `data:video/${fileExtension.replace(/\./g, '')};base64,` + currentMedia.base64)
                            src.setAttribute('type', `video/${fileExtension.replace(/\./g, '')}`)
                            video_playing = true
                            video_output.appendChild(src);
                            video_output.load()
                            video_output.play()
                        }
                    } catch (err) {
                        if (video_playing){
                            handleVideoEnd()
                        }
                    }

                }else{
                    counter = 0
                }
            }
            if (!video_playing)
                setTimeout(() => {
                    pres()
                }, duration || defaultDuration)
        }
        let determineType = (fileExtension) => {

            if (MEDIA_TYPES.image.includes(fileExtension)) {
                return 'image'
            } else if (MEDIA_TYPES.video.includes(fileExtension)) {
                return 'video'
            }
        }

        let longPolling = setInterval(() => {
            getImage(media)
        }, 3000)






    </script>
</body>

</html>