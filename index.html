<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body,
        #wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background: black;
        }

        #wrapper {
            opacity: 1;
            transition: opacity 2s ease-in-out;
        }

        #video_output {
            display: none;
            width: 100%;

        }

        #image_output {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <img id="image_output" src="/defaultImage">
        <video id="video_output">
    </div>


    </video>
    <script>
        let media = []
        let counter = 0
        let key = null
        let defaultDuration = 3000
        let duration
        let presPlaying = false;
        let video_playing = false
        const MEDIA_TYPES = {
            image: ['.jpg', '.jpeg', '.png', '.gif'],
            video: ['.mp4', '.webm']
        }
        let image_output = document.getElementById('image_output')
        let video_output = document.getElementById('video_output')
        let wrapper = document.getElementById('wrapper');
        video_output.addEventListener('ended', handleVideoEnd)
        getImage()

        //pres();

        function handleVideoEnd() {
            video_output.pause()
            wrapper.style.opacity = 0;
            setTimeout(() => {
                video_output.style.display = 'none'
                video_playing = false
                video_output.innerHTML=''
                playNextSlide(media[counter])
            }, 2000)
        }

        function getImage() {
            fetch('/getImages', {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key
                })
            })
                .then((e) => e.json())
                .then((res) => {
                    console.log(res)
                    if (res.key !== key) {
                        media = [...res.media]
                        key = res.key
                        defaultDuration = res.defaultDuration <= 0 ? 3000 : res.defaultDuration * 1000
                        if (!media.length) {
                           
                        } else if (!video_playing && !presPlaying) {
                            playNextSlide(media[counter])
                        }
                    }
                }).catch((err) => {
                    console.log(err)
                    media = [];
                });
        }


        let playNextSlide = (file) => {
            if (file) {
                try {
                    video_output.pause();
                } catch (err) {

                }
                presPlaying = true;
                wrapper.style.opacity = 0;
                setTimeout(() => {
                    let fileExtension = file.fileName.substr(file.fileName.lastIndexOf('.')).toLowerCase();
                    let fileType = determineType(fileExtension);
                    duration = file.params.duration * 1000;
                    if (fileType === 'image') {
                        video_output.style.display = "none"
                        video_output.innerHTML = '';
                        image_output.style.display = 'block'
                        image_output.src = `data:image/${fileExtension.replace(/\./g, '')};base64,` + file.base64;
                    } else if (fileType === 'video') {
                        image_output.style.display = 'none'
                        video_output.style.display = "block"
                        let src = document.createElement('source')
                        src.setAttribute('src', `data:video/${fileExtension.replace(/\./g, '')};base64,` + file.base64)
                        src.setAttribute('type', `video/${fileExtension.replace(/\./g, '')}`)
                        
                        video_output.appendChild(src);
                        video_output.load()
                        try{
                            video_output.play()
                            video_playing = true;
                        }catch(err){
                            video_playing=false;
                            console.log(err + "? ")
                        }
                        
                    }
                    wrapper.style.opacity = 1;
                    setTimeout(() => {
                        counter++;
                        if (!media[counter]) {
                            counter = 0;
                        }
                        if (!video_playing) {
                            setTimeout(() => {
                                playNextSlide(media[counter])
                            }, duration || defaultDuration)
                        }
                    }, 2000)

                }, 2000)
            } else {
                counter = 0;
                if (media[counter]) {
                    playNextSlide(media[counter])
                } else {
                    handleDefault();
                }
            }
        }
        let handleDefault = () => {
            if (image_output.src != '/defaultImage') {
                wrapper.style.opacity = 0;
                video_output.pause();
                video_output.innerHTML = '';
                setTimeout(() => {
                    video_output.style.display = "none";
                    image_output.style.display = "block";
                    image_output.src = "/defaultImage";
                    presPlaying = false;
                    wrapper.style.opacity = 1;
                }, 2000)
            }
        }
        let determineType = (fileExtension) => {
            if (MEDIA_TYPES.image.includes(fileExtension)) {
                return 'image'
            } else if (MEDIA_TYPES.video.includes(fileExtension)) {
                return 'video'
            }
        }

        let longPolling = setInterval(() => {
            getImage()
        }, 3000)














        // function pres() {
        //     if (media.length) {
        //         let currentMedia = media[counter]
        //         if (currentMedia) {
        //             try {
        //                 duration = currentMedia.params.duration * 1000;
        //                 let fileExtension = currentMedia.fileName.substr(currentMedia.fileName.lastIndexOf('.')).toLowerCase();
        //                 let mediaType = determineType(fileExtension);
        //                 if (mediaType === 'image') {
        //                     video_output.style.display = "none"
        //                     image_output.style.display = 'block'
        //                     image_output.src = `data:image/${fileExtension.replace(/\./g, '')};base64,` + currentMedia.base64
        //                     counter++
        //                     if (counter >= media.length) {
        //                         counter = 0
        //                     }
        //                     wrapper.style.opacity = 1;
        //                 } else {
        //                     image_output.style.display = 'none'
        //                     video_output.style.display = "block"
        //                     let src = document.createElement('source')
        //                     src.setAttribute('src', `data:video/${fileExtension.replace(/\./g, '')};base64,` + currentMedia.base64)
        //                     src.setAttribute('type', `video/${fileExtension.replace(/\./g, '')}`)
        //                     video_playing = true
        //                     video_output.appendChild(src);
        //                     video_output.load()
        //                     wrapper.style.opacity = 1;
        //                     video_output.play()
        //                 }
        //             } catch (err) {
        //                 if (video_playing) {
        //                     handleVideoEnd()
        //                 }
        //             }
        //         } else {
        //             counter = 0
        //         }
        //     }
        //     if (!video_playing)
        //         setTimeout(() => {
        //             wrapper.style.opacity = 0;
        //             setTimeout(() => {
        //                 pres()
        //             }, 2000)

        //         }, duration || defaultDuration)
        // }
    </script>
</body>

</html>