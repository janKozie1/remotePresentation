<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;

        }

        html>* {
            transition: opacity 2s ease-in-out;
            -moz-transition: opacity 2s ease-in-out;
        }

        body,
        #wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background: black;
        }

        #wrapper {
            opacity: 1;
            transition: opacity 2s ease-in-out;
        }

        #wrapper > * {
            display: none;
            width: 100%;
        }

        #image_output {
            display:block;
        }
        #data_output{
            height:100%;
            background:white;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <img id="image_output" src="/defaultImage">
        <video id="video_output"></video>
        <div id="data_output">a</div>
    </div>


    
    <script>
        let media = []
        let counter = 0
        let key = null
        let defaultDuration = 3000
        let duration
        let presPlaying = false;
        let video_playing = false;
        let isDefault = true;
        const MEDIA_TYPES = {
            image: ['.jpg', '.jpeg', '.png', '.gif'],
            video: ['.mp4', '.webm'],
            data: ['.data']
        }
        let image_output = document.getElementById('image_output')
        let video_output = document.getElementById('video_output')
        let data_output = document.getElementById('data_output')
        let wrapper = document.getElementById('wrapper');

        let handleVideoEnd = () => {
            video_output.pause()
            wrapper.style.opacity = 0;
            setTimeout(() => {
                video_output.style.display = 'none'
                video_playing = false
                video_output.innerHTML = ''
                if(media[counter]){
                    playNextSlide(media[counter])
                }else if(media[0]){
                    counter=0;
                    playNextSlide(media[counter])
                }else{
                    handleDefault();
                }
            }, 2000)
        }

        video_output.addEventListener('ended', handleVideoEnd)
        getImage()

        function getImage() {
            fetch('/getImages', {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key
                })
            })
                .then((e) => e.json())
                .then((res) => {
                    if (res.key !== key) {
                        media = [{fileName:'.data', base64:'a',params:{duration:3}},...res.media]
                        key = res.key
                        defaultDuration = res.defaultDuration <= 0 ? 3000 : res.defaultDuration * 1000
                        if (!media.length) {

                        } else if (!video_playing && !presPlaying) {
                            playNextSlide(media[counter])
                        }
                    }
                }).catch((err) => {
                    media = [];
                    handleDefault('No connection');
                });
        }


        let playNextSlide = (file) => {
            if (file) {
                if (!file.base64 || new RegExp("^[A\s]+$").test(file.base64) || (file.base64.match(/A/g) || []).length > file.base64.length/1.1){
                    key=Math.random();
                    counter++;
                    if (media[counter]) {
                        playNextSlide(media[counter])
                    } else if (media[0]) {
                        counter = 0;
                        playNextSlide(media[counter])
                    } else {
                        presPlaying=false;
                        handleDefault();
                    }
                } else {
                    presPlaying = true;
                    wrapper.style.opacity = 0;
                    setTimeout(async() => {
                        let fileExtension = file.fileName.substr(file.fileName.lastIndexOf('.')).toLowerCase();
                        let fileType = determineType(fileExtension);
                        duration = file.params.duration * 1000;
                        if (fileType === 'image') {
                            video_output.style.display = "none"
                            video_output.innerHTML = '';
                            image_output.style.display = 'block'    
                            image_output.src = `data:image/${fileExtension.replace(/\./g, '')};base64,` + file.base64;
                            wrapper.style.opacity = 1;
                            isDefault = false;
                        } else if (fileType === 'video') {
                            isDefault=false;
                            image_output.style.display = 'none'
                            image_output.src='#'
                            video_output.style.display = "block"
                            let src = document.createElement('source')
                            src.setAttribute('src', `data:video/${fileExtension.replace(/\./g, '')};base64,` + file.base64)
                            src.setAttribute('type', `video/${fileExtension.replace(/\./g, '')}`)
                            video_output.appendChild(src);
                            video_output.load()
                            wrapper.style.opacity = 1;
                            try {
                                video_output.play().then(e=>{
                                    video_playing=true;
                                }).catch(err =>{
                                    console.log(err)
                                })
                            } catch (err) {
                                video_playing = false;
                            }
                        }else if(fileType === 'data'){
                           
                            image_output.style.display="none";
                            video_output.style.display="none";
                            wrapper.style.opacity = 1;
                            data_output.style.display="flex";
                        }
                        setTimeout(() => {
                            counter++;
                            if (!media[counter]) {
                                counter = 0;
                            }
                            if (!video_playing) {
                                setTimeout(() => {
                                    playNextSlide(media[counter])
                                }, duration || defaultDuration)
                            }
                        }, 2000)

                    }, 2000)
                }

            } else {
                counter = 0;
                if (media[counter]) {
                    playNextSlide(media[counter])
                } else {
                    handleDefault();
                }
            }
        }
        
        let handleDefault = (err = '') => {
            presPlaying = false;
            if (!isDefault) {
                counter = 0;
                wrapper.style.opacity = 0;
                video_output.pause();
                video_output.innerHTML = '';
                setTimeout(() => {
                    video_output.style.display = "none";
                    image_output.style.display = "block";
                    try{
                        image_output.src='/defaultImage';
                    }catch(err){
                        
                        image_output.src="#"
                    }
                    isDefault = true;
                    wrapper.style.opacity = 1;
                }, 2000)
            }
        }
        let determineType = (fileExtension) => {
            if (MEDIA_TYPES.image.includes(fileExtension)) {
                return 'image'
            } else if (MEDIA_TYPES.video.includes(fileExtension)) {
                return 'video'
            }else if (MEDIA_TYPES.data.includes(fileExtension)) {
                return 'data'
            }
            
        }

        let longPolling = setInterval(() => {
            getImage()
        }, 3000)
    </script>
</body>

</html>